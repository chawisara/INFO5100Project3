<html>

<head>
<title>INFO 5100: Project 3 - Master Capstone</title>
<link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<style>
	body { font-family: "Muli", sans-serif; background-color: black;}
	/*svg {margin-left:auto; margin-right:auto; display: block}*/
	svg {display: block; float:left;}
	path { fill: #454545; stroke: #dfffa0; stroke-width: 1px;}
</style>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

</head>

<body>
	<br>
	<div id="top products" style="margin:auto;"></div>
	<br>
	<svg id="map" height="650" width="1100">
	</svg>
	<br><br>
	<div id="buttons">
		<button id="crops" style="cursor:pointer;">Crops</button>
		<button id="livestock" style="cursor:pointer;">Livestock</button>
		<button id="wildcrops" style="cursor:pointer;">Wild Crops</button>
		<button id="handling" style="cursor:pointer;">Handling</button>
		<button id="showAll" style="cursor:pointer;">Show All</button>
	</div>
	<br>
	<form onreset="showAllFarms()">
		<input type="text" id="datepicker" onchange="dateFilter(this.value)">
		<input type="reset" value="Clear" >
	</form>
	<button type="button" id="Political" onclick="showelectionData(counties)"> Political v. Top 10 </button>
	<script>
		var svg = d3.select("#map");
		var width=1100;
		var height=650;
		var centered;
		var USprojection = d3.geoAlbersUsa();
		var USpathGenerator = d3.geoPath().projection(USprojection);
		var states;
		var counties;
		var usdaAtlas;

		var zipData, farmData, stateData, topTenData, USMapData, electionData;
		var farms;

		var parseRowZip = function(line) {
			return{
				Zipcode: line["Zipcode"],
				City: line["City"],
				State: line["State"],
				Latitude: Number(line["Lat"]),
				Longitude: Number(line["Long"])
			}
		}

		var parseTopTen = function(line) {
			return{
				State: line["State"], 
				FIPS: Number(line["FIPS"])
			}
		}

		var parseRowFarms = function(line) {
			return{
				CertifierName: line["Certifier Name"],
				OperationID: line["Operation ID"],
				OperationName: line["Operation Name"],
				CertificationStatus: line["Operation Certification Status"],
				DateOfStatus: line["Effective Date of Operation Status"],
				CertifiedCrops: line["Certified Products Under CROPS Scope"],
				AdditionalCrops: line["Additional Certified Products Under CROPS Scope"],
				CertifiedLivestock: line["Certified Products Under LIVESTOCK Scope"],
				AdditionalLivestock: line["Additional Certified Products Under LIVESTOCK Scope"],
				CertifiedWildCrops: line["Certified Products Under WILD CROPS Scope"],
				AdditionalWildCrops: line["Additional Certified Products Under WILD CROPS Scope"],
				CertifiedHandling: line["Certified Products Under HANDLING Scope"],
				AdditionalHandling: line["Additional Certified Products Under HANDLING Scope"],
				AddressCity: line["Physical Address: City"],
				AddressState: line["Physical Address: State/Province"],
				AddressZip: line["Physical Address: ZIP/ Postal Code"],
				Phone: line["Phone"],
				Email: line["Email"]
				
			}
		}

		var parseRowStateCoordinates = function(line){
			return{
				State: line["State"],
				Latitude: Number(line["Latitude"]),
				Longitude: Number(line["Longitude"]),
				FIPS: Number(line["FIPS"])
			}
		}

		var parseElectionData = function(line){
			return{
				DemPercent: Number(line["per_dem"]),
				RepPercent: Number(line["per_gop"]),
				Abbreviation: line["state_abbr"],
				County: line["county_name"],
				ComboFIPS: Number(line["combined_fips"])
				
			}
		}

		var toptenFIPS=[];
		var electionFIPS=[];
		var electionResults=[];
		
		d3.queue()
		.defer(d3.json, "us.json")
		.defer(d3.csv, "zipcode.csv", parseRowZip)
		.defer(d3.csv, "organicfarms.csv", parseRowFarms)
		.defer(d3.csv, "statecoordinates.csv", parseRowStateCoordinates)
		.defer(d3.csv, "toptenorganic.csv", parseTopTen)
		.defer(d3.csv, "2016_US_County_Level_Presidential_Results.csv", parseElectionData)
		.await(function(error, USMapData, zipData, farmData, stateData, topTenData, electionData){

			states=topojson.feature(USMapData, USMapData.objects.states);
			counties=topojson.feature(USMapData, USMapData.objects.counties);

			zipData = zipData;
			farmData = farmData;
			stateData = stateData;
			topTenData = topTenData;
			electionData = electionData;

			electionData.forEach(function(d){
				electionFIPS.push(d.ComboFIPS);
			});

			// console.log("electionFIPS")
			// console.log(electionFIPS)

			topTenData.forEach(function(d){
				toptenFIPS.push(d.FIPS);
			});

			electionData.forEach(function(d){
				electionResults.push({FIPS: d.ComboFIPS, Dem: d.DemPercent, GOP: d.RepPercent})
			})

			// console.log("electionResults")
			// console.log(electionResults)

			var farms=dataPoints(zipData, stateData, farmData);

			showFarmsByState(farms, stateData, states);

			//showtopTen(states);

		});

		// var zips = [];
		var statecoordinates=[];
		var zipsObject = {};

		function dataPoints(zipData, stateData, farmData){
			var points = [];

			zipData.forEach(function(d){
				var coordinates=[d.Longitude, d.Latitude];
				// var zip={Zipcode: d.Zipcode, Coordinates: coordinates};
				// zips.push(zip);
				zipsObject[d.Zipcode] = coordinates;
			});
			
			stateData.forEach(function(d){
				var coordinates=[d.Longitude, d.Latitude];
				var state={State: d.State, Coordinates: coordinates, FarmCount: 0};
				statecoordinates.push(state);
			});

			farmData.forEach(function(data){
				var zipCoordinates;

				if(data.AddressZip.indexOf("-")!=-1){
					data.AddressZip=data.AddressZip.substring(0, data.AddressZip.indexOf("-"));
				}

				var farmCoordinates = getZipCoordinate(data.AddressZip);
				if(farmCoordinates!=undefined){
					var point={CertifierName: data.CertifierName, OperationID: data.OperationID, OperationName: data.OperationName, CertificationStatus: data.CertificationStatus,
					DateOfStatus: data.DateOfStatus, CertifiedCrops: data.CertifiedCrops, AdditionalCrops: data.AdditionalCrops, CertifiedLivestock: data.CertifiedLivestock,
					AdditionalLivestock: data.AdditionalLivestock, CertifiedWildCrops: data.CertifiedWildCrops, AdditionalWildCrops: data.AdditionalWildCrops,
					CertifiedHandling: data.CertifiedHandling, AdditionalHandling: data.AdditionalHandling, AddressCity: data.AddressCity, AddressState: data.AddressState,
					AddressZip: data.AddressZip, Coordinates: farmCoordinates, Phone: data.Phone, Email: data.Email};

					points.push(point);
				}

			});

			return points;
		}

		function getZipCoordinate(zipCode) {
			return zipsObject[zipCode];
		}

		function showFarmsByState(farmData, stateData, states){
			USprojection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], states);

			farms=farmData;

			var paths=svg.selectAll("path.country").data(states.features);
			paths.enter().append("path").attr("class","country")
			.merge(paths)
			.attr("d", function(country){
				return USpathGenerator(country);
			})
			.on("mouseover", function(d){
				this.setAttribute("style", "stroke-width: 4px");
				this.setAttribute("cursor", "pointer");
			})
			.on("mouseout", function(d){
				this.setAttribute("style", "stroke-width: 1px");
				this.setAttribute("cursor", "default");
			})
			.on("click", clicked);;

			var max=0;

			statecoordinates.forEach(function(state){
				var count=0;

				farms.forEach(function(farm){
					if(state.State==farm.AddressState){
						count++;
					}
				});

				state.FarmCount=count;
				if(max<count) max=count;

			});

			showAllFarms();

		}

		// function showtopTen(states){
		// 	var paths=svg.selectAll("path.country").data(states.features);
		// 	paths.enter().append("path").attr("class","country")
		// 	.merge(paths)
		// 	.style("fill", function (states) {
		// 		if (toptenFIPS.indexOf(states.id)>-1) {
		// 			return "#3566CC";
		// 		}else{
		// 			return "#ccc";
		// 		}
		// 	});
		// }

		function showelectionData(counties){
			
			// console.log("in showelectionData")
			

			//console.log(electionData);
			// var colorBlue = d3.scale.threshold().domain([0.02, 0.04, 0.06, 0.08, 0.10]).range(["#f2f0f7", "#dadaeb", "#bcbddc", "#9e9ac8", "#756bb1", "#54278f"]);
			// var colorRed
			// console.log("showelectionData function")
			var colors = ["#4C0000", "#661919", "#7F3333", "#994C4C", "#B26666", "#CC7F7F", "#E59999", "#FFB2B2", "#FFCCCC", "#FFE5E5"];
			var percentScale = d3.scaleQuantize().domain([0, 100]).range(colors);
			var paths=svg.selectAll("path.country").data(counties.features);
			// console.log(paths)
			paths.enter().append("path").attr("class", "country")
			.merge(paths)
			.transition().duration(1000)
			.style("fill", function(d) { 

				if (electionFIPS.indexOf(d.id)>-1) {
						// console.log("next")
						return "#4C0000"
					} else {
						return "#454545";
						// }
					}
			})
			.attr("d", function (county) {
				return USpathGenerator(county);
			})
			.on("mouseover", function(d){
				this.setAttribute("style", "stroke-width: 4px");
				this.setAttribute("cursor", "pointer");
			})
			.on("mouseout", function(d){
				this.setAttribute("style", "stroke-width: 1px");
				this.setAttribute("cursor", "default");
			})
			.on("click", clicked);

			//.style("fill", function (d) {
			// 	if states.DemPercent < states.RepPercent{
			// 		return colorBlue(d.RepPercent = electionFIPS.get(d.id));
			// 	} else {
			// 		return colorRed(d.DemPercent = electionData.get(d.id));
			// 	}
				
			// });

		}


		// function ready(error, us) {
		//   if (error) throw error;

		//   svg.append("g")
		//       .attr("class", "counties")
		//     .selectAll("path")
		//     .data(topojson.feature(USMapData, USMapData.objects.counties).features)
		//     .enter().append("path")
		//       .attr("fill", function(d) { return color(d.rate = unemployment.get(d.id)); })
		//       .attr("d", path)
		//     .append("title")
		//       .text(function(d) { return d.rate + "%"; });

		//   svg.append("path")
		//       .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
		//       .attr("class", "states")
		//       .attr("d", path);
		// }



		//code reference: https://bl.ocks.org/mbostock/2206590

		function clicked(d) {
			var x, y, k;

			if (d && centered !== d) {
				var centroid = USpathGenerator.centroid(d);
				x = centroid[0];
				y = centroid[1];
				k = 4;
				centered = d;
				svg.selectAll("circle")
				.transition()
				.duration(750)
				.attr("r", 0.8);
			} else {
				x = width / 2;
				y = height / 2;
				k = 1;
				centered = null;
				svg.selectAll("circle")
				.transition()
				.duration(750)
				.attr("r", 3);
			}

			svg.selectAll("path")
			.classed("active", centered && function(d) { return d === centered; });

			svg.transition()
			.duration(750)
			.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
			.style("stroke-width", 1.5 / k + "px");

		}

		d3.select("#crops").on("click", crops_clicked);
		d3.select("#livestock").on("click", livestock_clicked);
		d3.select("#wildcrops").on("click", wildcrops_clicked);
		d3.select("#handling").on("click", handling_clicked);
		d3.select("#showAll").on("click", showAll_clicked);

		function crops_clicked(){
			d3.selectAll("circle").style("opacity", 0.5)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 1.0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0.5);
			});

			d3.selectAll(".CertifiedCrops").style("opacity", 0)
			.on("mouseover", function(d){
				console.log("click");
				this.setAttribute("opacity", 0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0);
			});
		}

		function livestock_clicked(){
			d3.selectAll("circle").style("opacity", 0.5)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 1.0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0.5);
			});

			d3.selectAll(".CertifiedLivestock").style("opacity", 0)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0);
			});
		}

		function wildcrops_clicked(){
			d3.selectAll("circle").style("opacity", 0.5)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 1.0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0.5);
			});

			d3.selectAll(".CertifiedWildCrops").style("opacity", 0)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0);
			});
		}

		function handling_clicked(){
			d3.selectAll("circle").style("opacity", 0.5)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 1.0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0.5);
			});

			d3.selectAll(".CertifiedHandling").style("opacity", 0)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0);
			});
		}

		function showAll_clicked(){
			d3.selectAll("circle").style("opacity", 0.5)
			.on("mouseover", function(d){
				this.setAttribute("opacity", 1.0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0.5);
			});
		}


		$("#datepicker").datepicker({
			changeMonth: true,
			changeYear: true,
			showButtonPanel: true,
			yearRange: '1975:2017',
			maxDate: new Date(),
			minDate: new Date(1975, 7, 31)
		});

		function dateFilter(inputDate){
			if(inputDate==""){
				showAllFarms();
			}else{
				svg.selectAll("circle").remove();
				svg.selectAll("circle")
				.data(farms.filter(function(d) {
					var minDate=new Date(1975, 7, 31);
					var farmDate=new Date(d.DateOfStatus);
					var input=new Date(inputDate);
					return farmDate<=input && farmDate>=minDate;
				}))
				.enter().append("circle")
				.attr("id", function(d){return d.OperationName;})
				.attr("class", function(d){
					var classname="";
					if(d.CertifiedCrops) classname="CertifiedCrops";
					if(d.CertifiedHandling) classname+=" CertifiedHandling";
					if(d.CertifiedLivestock) classname+=" CertifiedLivestock";
					if(d.CertifiedWildCrops) classname+=" CertifiedWildCrops";
					return classname;
				})
				.attr("cx", function(d){return USprojection(d.Coordinates)[0];})
				.attr("cy", function(d){return USprojection(d.Coordinates)[1];})
				.attr("r", 3)
				.attr("opacity", 0.5)
				.style("fill", "white")
				.on("mouseover", function(d){
					this.setAttribute("opacity", 1.0);
					// this.setAttribute("cursor", "pointer");
				})
				.on("mouseout", function(d){
					this.setAttribute("opacity", 0.5);
					// this.setAttribute("cursor", "default");
				});
			}

		}

		function showAllFarms(){
			svg.selectAll("circle").remove();
			svg.selectAll("circle")
			.data(farms)
			.enter().append("circle")
			.attr("id", function(d){return d.OperationName;})
			.attr("class", function(d){
				var classname="";
				if(d.CertifiedCrops) classname="CertifiedCrops";
				if(d.CertifiedHandling) classname+=" CertifiedHandling";
				if(d.CertifiedLivestock) classname+=" CertifiedLivestock";
				if(d.CertifiedWildCrops) classname+=" CertifiedWildCrops";
				return classname;
			})
			.attr("cx", function(d){return USprojection(d.Coordinates)[0];})
			.attr("cy", function(d){return USprojection(d.Coordinates)[1];})
			.attr("r", 3)
			.attr("opacity", 0.5)
			.style("fill", "white")
			.on("mouseover", function(d){
				this.setAttribute("opacity", 1.0);
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0.5);
			});
		}


	</script>
</body>


</html>
