<html>

<head>
<title>INFO 5100: Project 3 - Master Capstone</title>
<link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
<style>
	body { font-family: "Muli", sans-serif;}
	/*svg {border: solid #ccc 1px; }*/
	path { fill: #ccc; stroke: white; stroke-width: 1px;}
</style>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>

</head>

<body>
	<svg id="map" height="650" width="1100">
	</svg>
	<script>
		var svg = d3.select("#map");
		var USprojection = d3.geoAlbersUsa();
		var USpathGenerator = d3.geoPath().projection(USprojection);
		var states;

		var zipData, farmData, stateData, topTenData, USMapData;

		var parseRowZip = function(line) {
			return{
				Zipcode: line["Zipcode"],
				City: line["City"],
				State: line["State"],
				Latitude: Number(line["Lat"]),
				Longitude: Number(line["Long"])
			}
		}

		var parseTopTen = function(line) {
			return{
				State: line["State"]
				//for Dana: add FIPS column
			}
		}

		var parseRowFarms = function(line) {
			return{
				CertifierName: line["Certifier Name"],
				OperationID: line["Operation ID"],
				OperationName: line["Operation Name"],
				CertificationStatus: line["Operation Certification Status"],
				DateOfStatus: line["Effective Date of Operation Status"],
				CertifiedCrops: line["Certified Products Under CROPS Scope"],
				AdditionalCrops: line["Additional Certified Products Under CROPS Scope"],
				CertifiedLivestock: line["Certified Products Under LIVESTOCK Scope"],
				AdditionalLivestock: line["Additional Certified Products Under LIVESTOCK Scope"],
				CertifiedWildCrops: line["Certified Products Under WILD CROPS Scope"],
				AdditionalWildCrops: line["Additional Certified Products Under WILD CROPS Scope"],
				CertifiedHandling: line["Certified Products Under HANDLING Scope"],
				AdditionalHandling: line["Additional Certified Products Under HANDLING Scope"],
				AddressCity: line["Physical Address: City"],
				AddressState: line["Physical Address: State/Province"],
				AddressZip: line["Physical Address: ZIP/ Postal Code"],
				Phone: line["Phone"],
				Email: line["Email"]
				
			}
		}

		var parseRowStateCoordinates = function(line){
			return{
				State: line["State"],
				Latitude: Number(line["Latitude"]),
				Longitude: Number(line["Longitude"])
			}
		}

		var FIPSdata;

		d3.queue()
		.defer(d3.json, "us.json")
		.defer(d3.csv, "zipcode.csv", parseRowZip)
		.defer(d3.csv, "organicfarms.csv", parseRowFarms)
		.defer(d3.csv, "statecoordinates.csv", parseRowStateCoordinates)
		.defer(d3.csv, "toptenorganic.csv", parseTopTen)
		.await(function(error, USMapData, zipData, farmData, stateData, topTenData){

			states=topojson.feature(USMapData, USMapData.objects.states);

			//For Dana: this would only work when u add the FIPS column
			FIPSdata = d3.map(topTenData, function (d) {
				return d.FIPS;
			});

			zipData = zipData;
			farmData = farmData;
			stateData = stateData;
			topTenData = topTenData;

			var farms=dataPoints(zipData, stateData, farmData);

			showFarmsByState(farms, stateData, states);

			showtopTen(topTenData);


			
		});

		var zips = [];
		var statecoordinates=[];
		var zipsObject = {};
		
		function dataPoints(zipData, stateData, farmData){
			var points = [];

			zipData.forEach(function(d){
				var coordinates=[d.Longitude, d.Latitude];
				var zip={Zipcode: d.Zipcode, Coordinates: coordinates};
				zips.push(zip);
				zipsObject[d.Zipcode] = coordinates;
			});
			
			stateData.forEach(function(d){
				var coordinates=[d.Longitude, d.Latitude];
				var state={State: d.State, Coordinates: coordinates, FarmCount: 0};
				statecoordinates.push(state);
			});

			farmData.forEach(function(data){
				var zipCoordinates;

				if(data.AddressZip.indexOf("-")!=-1){
					data.AddressZip=data.AddressZip.substring(0, data.AddressZip.indexOf("-"));
				}

				var farmCoordinates = getZipCoordinate(data.AddressZip);

				var point={CertifierName: data.CertifierName, OperationID: data.OperationID, OperationName: data.OperationName, CertificationStatus: data.CertificationStatus,
					DateOfStatus: data.DateOfStatus, CertifiedCrops: data.CertifiedCrops, AdditionalCrops: data.AdditionalCrops, CertifiedLivestock: data.CertifiedLivestock,
					AdditionalLivestock: data.AdditionalLivestock, CertifiedWildCrops: data.CertifiedWildCrops, AdditionalWildCrops: data.AdditionalWildCrops,
					CertifiedHandling: data.CertifiedHandling, AdditionalHandling: data.AdditionalHandling, AddressCity: data.AddressCity, AddressState: data.AddressState,
					AddressZip: data.AddressZip, Coordinates: farmCoordinates, Phone: data.Phone, Email: data.Email};

				points.push(point);

			});

			console.log(points);

			return points;
		}

		function getZipCoordinate(zipCode) {
			return zipsObject[zipCode];
		}

		// function findZipCoordinates(zips, zipcode){
		// 	var coordinates=[];
		// 	zips.some(function(d){
		// 		if(d.Zipcode==zipcode){
		// 			coordinates.push(d.Coordinates);
		// 			return true;
		// 		}else return false;
		// 	});
		// 	return coordinates;
		// }

		function showFarmsByState(farms, stateData, states){
			USprojection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], states);


			var paths=svg.selectAll("path.country").data(states.features);
			paths.enter().append("path").attr("class","country")
			.merge(paths)
			.attr("d", function(country){
				return USpathGenerator(country);
			});



			var max=0;

			statecoordinates.forEach(function(state){
				var count=0;

				farms.forEach(function(farm){
					if(state.State==farm.AddressState){
						count++;
					}
				});

				state.FarmCount=Math.sqrt(count);
				if(max<count) max=Math.sqrt(count);
			});

			var farmCountExtent = d3.extent(statecoordinates, function (d) { return d.FarmCount; });
			var farmCountScale = d3.scaleLinear().domain(farmCountExtent).range([0,20]);

			svg.selectAll("circle")
			.data(statecoordinates)
			.enter().append("circle")
			.attr("id", function(d){return d.State;})
			.attr("cx", function(d){return USprojection(d.Coordinates)[0];})
			.attr("cy", function(d){return USprojection(d.Coordinates)[1];})
			.attr("r", function(d){return farmCountScale(d.FarmCount);})
			.style("opacity", 0.7)
			.style("fill", "red")
			.on("mouseover", function(d){
				this.setAttribute("opacity", 1.0);
				// this.setAttribute("cursor", "pointer");
			})
			.on("mouseout", function(d){
				this.setAttribute("opacity", 0.7);
				// this.setAttribute("cursor", "default");
			});

		}
		//var topData = ["California","Texas","Washington","Pennsylvania","Oregon","Wisconsin", "Texas", "New York", "Colorado", "Michigan", "Iowa"]
		function showtopTen(topTenData){
			
			var paths=svg.selectAll("path.country").data(topTenData);
			paths.enter().append("path").attr("class","state")
			.merge(paths)
			// .style("fill", "#7FA2CC");
			.style("fill", function (states) {
				//for Dana: 
				var stateData=FIPSdata.get(states.id);
				if (stateData) {
					//return the color you want; can make it a scale
					//example: var color = d3.scaleQuantize().domain(ownershipExtent).range([*colors*]);
					//return color(Number(stateData.Ownership));
				}
			});

			// stateData.forEach(function(d){
			// 	console.log(d.State)
			// });
			// color = ["#7FA2CC"];

			// stateData.forEach(function(d){
				// if (stateData.State == "California") {
				// 	console.log("right")
				// }
			// });

			//|| "Texas" || "Washington" || "Pennsylvania" || "Oregon" || "Wisconsin" || "Texas" || "New York" || "Colorado" || "Michigan" || "Iowa"
			// console.log(stateData.State)
			
				
			// 	console.log(topData);

			// var paths=svg.selectAll("path.country").data(topData);
			// paths.enter().append("path").attr("class","country")
			// .merge(paths)
			// .style("fill", "#7FA2CC");

			// .attr("d", function(state){
			// 	console.log(state.State)
			// 	// if(country.State==(California || Texas || Washington || Pennsylvania || Oregon || Wisconsin || Texas || New York || Colorado || Michigan  || Iowa)){
			// 	return USpathGenerator()
			// 	// };
			// });

			

		// 	// var paths = svg.selectAll("path.country").data(counties.features);
		// 	// paths.enter().append("path").attr("class", "country")
		// 	// .on("click", function (d) { console.log(d.id); })
		// 	// .merge(paths)
		// 	// .transition().duration(1000)
		// 	// .style("fill", "blue")
		// 	// .attr("d", function (county) {
		// 	// 	return pathGenerator(county);
		// 	// });
		}

	</script>
</body>


</html>
